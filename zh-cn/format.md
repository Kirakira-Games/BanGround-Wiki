# 格式与结构

这一部分的内容主要针对开发者，如果您是普通玩家，可以跳过这一部分。

在阅读此部分之前，请先确认您对于json格式有一定的了解，且对游戏玩法有充足的认知。



导入包通常是以```.kirapack```为后缀名的zip压缩文件，用于导入到```BanGround-Unity```中进行游戏。

以下是导入包可能包含的内容说明。

## 导入音乐

音乐以自身的音乐ID（mid）区分。以下的文件均位于```music```文件夹下，以对应的音乐ID命名的文件夹内。

### 音乐文件

标准的音乐文件为oggVorbis格式，后缀名为```.ogg```的音乐文件。建议的码率为**96kbps**，不超过128kbps，且不包含封面信息和头部数据。

**音乐文件的文件名必须以其音乐ID命名。**如：音乐ID为98的音乐文件，其文件名必须为：98.ogg。

### 音乐信息文件

音乐的信息文件是后缀名为```.bin```的二进制文件。

**该文件的文件名必须为```mheader```。**

导入时，可以选择使用```mheader.json```来代替```mheader.bin```，程序会自动转换格式。

* ```mheader.json```的说明

  ```mheader.json```包含以下属性：

  * mid

    音乐ID。为一个整数。

  * title

    音乐标题。为一个字符串。

    表示对应音乐的歌曲名。

  * artist

    音乐艺术家。为一个字符串。

    表示对应音乐的参与创作的艺术家名。

  * preview

    预览区间。为一个正数值数组，有且仅有两个不同的数值。

    在谱面没有单独设定预览区间时，将使用此预览区间作为选歌界面的音乐预览期间。

    选歌界面切换到使用此音乐的谱面时，将循环播放指定区间的音乐。

  * BPM

    每分钟节拍数区间。为一个正数值数组，至少有一个数值且至多有两个数值。

    表示音乐的BPM区间，以供使用者参考。

  * length

    音乐长度。为一个正数值。

    表示音乐的长度，以供使用者参考。

  一个```mheader.json```的示例如下：

  ```json
  {
      "mid": 128,
      "title": "六兆年と一夜物語",
      "artist": "Roselia",
      "preview": [57.850, 78.124],
    "BPM": [85, 186],
      "length": 103.808
  }
  ```
  
  

## 导入谱面

谱面以自身的谱面ID（cid）区分。以下的文件均位于```chart```文件夹下，以对应的谱面ID命名的文件夹内。

### 谱面文件

谱面文件是后缀名为```.bin```的二进制文件。

该文件的文件名必须为其对应的难度名，即以下<span name="diffcultyNames">五个字符串</span>之一：

* easy
* normal
* hard
* expert
* special

导入时，可以使用对应的```.json```文件来代替```.bin```文件，程序会自动转换格式。

* 对应难度```*.json```的说明

  该文件包含以下属性：

  * difficulty

    谱面的难度名。为一个字符串。

    必须为上述的五个[难度名](#diffcultyNames)之一，且首字符大写。

  * level

    谱面的难度等级。为一个正整数。

  * offset

    谱面的偏移。为一个整数。

    表示谱面相对于音乐的偏移。为正数则延后，为负数则提前。

  * notes

    谱面的音符信息，为一个对象数组。

    音符对象有必须包含的通用属性，如下：

    * type

      音符对象的类型。为一个字符串。

      必须为以下五个字符串之一：

      * BPM
      * Single
      * Flick
      * SlideTick
      * SlideTickEnd

      使用不同的类型，其表示的意义也不同。

      建议第一个音符对象的```type```属性设定为```BPM```。

    * <span name="noteObject_beat">beat</span>

      音符对象所处的节拍位置。为一个整数数组，有且仅有三个整数。

      用**带分数**表示的节拍位置，三个整数依次对应带分数的**整数部分**、**分数部分的分子**、**分数部分的分母**。

      建议第一个音符对象的```beat```属性设定为```[0, 0, 1]```。

    以下是```type```属性不同时，各个音符对象的说明：

    * BPM

      表示从指定的位置开始，谱面的BPM变化。

      其包含的属性如下：

      * value

        要变更到的BPM数值。为一个正数值。

      * anims

        动作信息。为一个对象数组。

        **在任何一个BPM对象里填入相同的动作信息，其效果相同。**这意味着，您既可以把动作信息整合在一个BPM对象里，也可以分散在多个BPM对象里。
        
        动作对象包含的属性如下：
        
        * beat
        
          动作对象所处的节拍位置。与[音符对象的beat属性](#noteObject_beat)相同。
        
        * speed
        
          谱面整体变速的倍率。为一个数值。
        
          **按倍率变速只影响视觉效果，不影响实际的判定时机。**
        
          如果设定为大于1的数值，则有“加速”（音符间距增大）的效果；小于1的数值，则有“减速”（音符间距减小）的效果；0，则会有“时停”的效果；负数，则会有“倒退”的效果。

    * Single/Flick/SlideTick/SlideTickEnd

      表示指定的位置存在的音符。

      为了方便，以下将```type```属性为：```Single```的称为**单键**；```Flick```的称为**滑键**；```SlideTick```的称为**滑条节点**；```SlideTickEnd```的称为**滑条尾**。

      其包含的通用属性如下：

      * lane

        音符所处的轨道。为一个不小于0且不大于6的自然数，或-1。

        自然数从小到大，对应第1至第7条轨道。

        如果设定为-1，则为**fuwafuwa音符**，**必须提供```x```、```y```属性**。

        ```x```、```y```属性与此属性同级，说明如下：

        * x

          音符的横向位置，为一个不小于0且不大于6的数值。
      
          数值从小到大，对应从左到右的位置。
      
        * y
      
          音符的纵向位置，为一个不小于0且不大于1的数值。
      
          数值从小到大，对应从**地面轨道**到**fuwafuwa轨道**的位置。
      
      * tickStack
      
        音符所属的节点栈。为-1或一个自然数。
      
        当```tickStack```设定为-1时，表示这是一个单独的音符。**只有单键和滑键才可以设定为-1。**
      
        当节点栈为一个自然数时，表示这是某个滑条的一部分。从一个**单键**开始，到一个**```tickStack```值相同**的**滑键**或**滑条尾**为止，它们和它们之间的**滑条节点**属于同一个滑条。
        
      * anims
      
        动作信息。为一个对象数组。
      
        动作对象包含的属性如下：
      
        * beat
      
          动作对象所处的节拍位置。与[音符对象的beat属性](#noteObject_beat)相同。
      
        * speed
      
          对应音符变速的倍率。为一个数值。
      
          **按倍率变速只影响视觉效果，不影响实际的判定时机。**
      
          如果设定为大于1的数值，则有“加速”的效果；小于1的数值，则有“减速”的效果；0，则会有“时停”的效果；负数，则会有“倒退”的效果。
      
        * lane
      
          音符在指定时刻所处的轨道。为一个不小于0且不大于6的数值。
      
          **指定轨道只影响视觉效果，不影响实际的判定时机。**所以请您**务必确认玩家能够正确识别音符所处的轨道。**
      
        * y
      
          音符在指定时刻所处的纵向位置。为一个不小于0且不大于1的数值。
      
          **指定纵向位置只影响视觉效果，不影响实际的判定时机。**所以请您**务必确认玩家能够正确识别音符所处的纵向位置。**
  
  一个谱面json文件的示例如下：
  
  ```json
  {
      "difficulty": "Expert",
      "level": 29,
      "offset": 0,
      "notes": [
          {
              "type": "BPM",
              "beat": [0, 0, 1],
              "value": 85.0,
              "anims": [{
                  "beat": [2, 0, 1],
                  "speed": 0.75
              }]
          },
          {
              "type": "Single",
              "beat": [2, 0, 1],
              "lane": -1,
              "tickStack": 0,
              "anims": [{
                  "beat": [1, 0, 1],
                  "speed": 1.25,
                  "lane": 1.5,
                  "y": 1.0
              }],
              "x": 0.0,
              "y": 1.0
          }
      ]
  }
  ```

### 谱面信息文件

谱面的信息文件是后缀名为```.bin```的二进制文件。

**该文件的文件名必须为```cheader```。**

导入时，可以选择使用```cheader.json```来代替```cheader.bin```，程序会自动转换格式。

* ```cheader.json```的说明

  ```cheader.json```包含以下属性：

  * version

    谱面版本号。为一个正整数。

  * sid

    谱面集合ID。为一个整数。

  * mid

    使用的音乐ID。为一个整数。

  * author

    作者名。为一个字符串。

    一般是作者的用户名。

  * authorNick

    作者昵称。为一个字符串。

    一般是作者的昵称。

  * difficulty

    难度的难度等级。为一个对象。

    表示每个难度的难度等级。属性名必须为五个[难度名](#diffcultyNames)之一。

  * noteNum

    难度的音符数量。为一个对象。

    表示每个难度的音符数量。属性名必须为五个[难度名](#diffcultyNames)之一。

  * backgroundFile

    背景文件。为一个对象。

    其中包含的属性如下：

    * pic

      背景图片。为一个字符串。

      使用的背景图片的文件名。文件名相对于谱面所在的文件夹。

    * vid

      背景视频。为一个字符串。

      使用的背景视频的文件名。文件名相对于谱面所在的文件夹。

  * preview

    预览区间。为一个正数值数组，有且仅有两个不同的数值。

    在谱面设定了预览区间时，将使用此预览区间作为选歌界面的音乐预览期间。

    选歌界面切换到使用此音乐的谱面时，将循环播放指定区间的音乐。

  * tag

    谱面标签。为一个字符串数组。

    谱面的标签，可以使用标签搜索到谱面。

  一个```cheader.json```文件的示例如下：

  ```json
  {
      "version": 1,
      "sid": 210,
      "mid": 128,
      "author": "Bushiroad",
      "authorNick": "ブシロード",
      "difficulty": {
          "easy": 8,
          "normal": 14,
          "hard": 21,
          "expert": 29,
          "special": 29
      },
      "noteNum": {
          "easy":157,
          "normal":286,
          "hard":501,
          "expert":895,
          "special":935
      },
      "backgroundFile": {
          "pic": "bg.jpg",
          "vid": "bg.mp4"
      },
      "preview": [57.850, 78.124],
      "tag": [
          "Six",
          "trillion",
          "years",
          "and",
          "one",
          "night",
          "story"
      ]
  }
  ```

### 脚本文件

**查看以下内容之前，请确认您有一定的数学知识和编程知识，尤其是对于lua脚本的写法。如果您不了解什么是lua脚本，建议您先学习后再继续查看。**

脚本文件通常是一个后缀名为```.lua```的LUA脚本文件，用于控制镜头效果。

该文件的文件名必须为其对应的[难度名](#diffcultyNames)。

脚本文件不是必须存在的。

要查看详细的编写说明，请见[脚本](script)。

## 示例

假设玩家在社区选取了3个谱面集进行下载，其中：

> * 3个谱面集的ID（sid）分别为10、98、191；
> * ID为10、98的谱面集调用的是音乐ID（mid）是11；
> * ID为191的谱面集调用的音乐ID是45。

- music
  - 11
    - 11.ogg
    - mheader.bin
  - 45
    - 45.ogg
    - mheader.bin

- chart
  - 10
    - cheader.bin
    - easy.bin
    - expert.bin
    - bg.jpg
    - bg.mp4
    - expert.lua
  - 98
    - ...
  - 191
    - ...

<vssue title="Vssue Demo" />